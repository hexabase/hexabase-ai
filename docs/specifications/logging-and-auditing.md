# HKS Logging and Auditing Architecture

## 1. Overview

This document defines the comprehensive logging and auditing strategy for the Hexabase KaaS (HKS) platform. The goal is to provide visibility for different stakeholders (HKS Developers, Organization Admins, Workspace Admins, Users) into system health, user activities, and application behavior.

We classify logs into three distinct categories based on their purpose and audience.

## 2. Log Categories and Technology Stack

| Log Category      | Description                                                                                              | Primary Audience   | Storage Technology | Visualization       | Data Retention                                    |
| :---------------- | :------------------------------------------------------------------------------------------------------- | :----------------- | :----------------- | :------------------ | :------------------------------------------------ |
| **System Logs**   | Logs generated by HKS platform components (Control Plane, AIOps, etc.) for debugging and monitoring.     | HKS SRE/Developers | **Loki**           | Grafana             | Medium-term (e.g., 30 days)                       |
| **Audit Logs**    | Immutable record of actions taken by users or by automated systems (like AIOps) on their behalf.         | HKS Admins, Users  | **ClickHouse**     | Grafana, User Pages | Long-term (e.g., 1+ years, for compliance)        |
| **Workload Logs** | Logs from user-deployed applications (`stdout`/`stderr` from pods) running within a project's namespace. | Users              | **Loki**           | Grafana             | Short/Medium-term (e.g., 7-30 days, configurable) |

### 2.1 Visualization and Access Control

**Grafana** will serve as the central hub for visualizing all log types. A robust Single Sign-On (SSO) integration with the HKS user management system is a prerequisite. This integration must ensure strict data tenancy, allowing users to view only the logs and dashboards relevant to their permissions.

## 3. System Logs

- **Source**: All HKS backend components, including the Go Control Plane, Python AIOps system, and other supporting services.
- **Collection**: Services will log `stdout`/`stderr` in a structured format (e.g., JSON). A log collection agent (e.g., Promtail) will be deployed within the Kubernetes cluster to automatically scrape these logs and forward them to a central Loki instance.
- **Purpose**: To monitor the health of the HKS platform, diagnose issues, and analyze performance. These logs are primarily for internal HKS operational staff.

## 4. Audit Logs

Audit logs provide a "who, what, when, where" record of all significant events and changes within the HKS platform.

- **Source**:
  - **HKS API**: All state-changing actions made through the HKS API (UI, CLI, or direct calls). This includes workspace/project management, user invites, plan changes, etc.
  - **Kubernetes API Server**: All actions performed via `kubectl` or other Kubernetes clients. This is captured using a Kubernetes [Audit Webhook](https://kubernetes.io/docs/tasks/debug/debug-cluster/audit/#webhook-backend). A dedicated HKS service will receive these events, correlate them with the HKS user, and forward them to ClickHouse.
  - **AIOps System**: When an AIOps agent executes an action (e.g., scaling a deployment), it calls the HKS Internal API. This call is logged as an audit event, attributed to the impersonated user, with an additional field indicating it was `initiated_by: "AIOpsAgent"`.
- **Storage**: Events are stored in a `logs.audit` table in ClickHouse. The schema will be designed for efficient querying and will include fields like `timestamp`, `user_id`, `user_email`, `source_ip`, `event_type`, `resource_type`, `resource_id`, `details_json`, `initiated_by`, etc.
- **Access Control and Visibility**:
  - **Organization Admin**: Can view all audit logs within their organization, focusing on high-level events like Workspace creation/deletion and Billing changes.
  - **Workspace Admin**: Can view all audit logs within their assigned workspaces, including Project creation/deletion and user role changes within the workspace.
  - **User**: Can view audit logs related to their own actions or actions performed on their behalf on resources they have access to. A dedicated "Activity Log" page will be provided in their personal dashboard.

## 5. Workload Logs

- **Source**: All pods running within user namespaces (i.e., inside an HKS Project).
- **Collection**: Promtail, running as a DaemonSet, will automatically discover and scrape logs from all user pods on each node.
- **Access**: Users can access their workload logs through Grafana. The Grafana instance will be pre-configured with data sources and dashboards that are automatically filtered by the user's accessible projects/namespaces, ensuring they cannot see logs from other tenants.

## 6. Relationship with AIOps Tracing (Langfuse)

It is important to distinguish Audit Logs from the AIOps tracing system (Langfuse).

- **Langfuse**: A specialized tool for **developers** to debug the AI. It traces the _internal reasoning_ of the agent chain (e.g., "Orchestrator decided to call the Kubernetes tool with these arguments"). It records thoughts, prompts, and intermediate steps.
- **ClickHouse (Audit Logs)**: A system of record for **users and admins**. It logs the _final, executed action_ that resulted from the agent's reasoning (e.g., "User 'bob@example.com' via AIOps scaled deployment 'nginx' to 3 replicas").

This separation ensures that developers have the detailed traces they need, while users and admins have a clean, compliant audit trail of significant events.
