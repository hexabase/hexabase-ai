name: Notify Discord on Issue Updates and Comments

on:
  issues:
    types: [opened, closed, reopened, edited, assigned]
  issue_comment:
    types: [created]

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: Send Discord Notification
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
          ISSUE_TITLE: ${{ github.event.issue.title }}
          ISSUE_URL: ${{ github.event.issue.html_url }}
          ISSUE_BODY: ${{ github.event.issue.body }}
          ISSUE_AUTHOR: ${{ github.event.issue.user.login }}
          ACTION_TYPE: ${{ github.event.action }}
          REPO_NAME: ${{ github.repository }}
          COMMENT_BODY: ${{ github.event.comment.body }}
          COMMENT_AUTHOR: ${{ github.event.comment.user.login }}
          GITHUB_EVENT_NAME: ${{ github.event_name }}
        run: |
          # ã‚¤ãƒ™ãƒ³ãƒˆç¨®åˆ¥ã‚’åˆ¤å®š
          if [ "$GITHUB_EVENT_NAME" == "issue_comment" ]; then
            ESCAPED_BODY=$(echo "$COMMENT_BODY" | jq -Rs .)  # JSONã‚¨ã‚¹ã‚±ãƒ¼ãƒ—
            COLOR=16777215  # âšª ç™½ (ã‚³ãƒ¡ãƒ³ãƒˆ)
            STATUS="ğŸ’¬ New Comment by $COMMENT_AUTHOR"
            COLOR=16777215  # âšª ç™½ (ã‚³ãƒ¡ãƒ³ãƒˆ)
            STATUS="ğŸ’¬ New Comment by $COMMENT_AUTHOR"
          else
            ESCAPED_BODY=$(echo "$ISSUE_BODY" | jq -Rs .)  # Issue æœ¬æ–‡ã‚’ JSON ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—
            COMMENT_AUTHOR=""

            case "$ACTION_TYPE" in
              "opened")
                COLOR=16711680  # ğŸ”´ èµ¤ (æ–°è¦ Issue)
                STATUS="ğŸ†• New Issue Created"
                ;;
              "closed")
                COLOR=65280  # ğŸŸ¢ ç·‘ (ã‚¯ãƒ­ãƒ¼ã‚º)
                STATUS="âœ… Issue Closed"
                ;;
              "reopened")
                COLOR=16711935  # ğŸ’– ãƒ”ãƒ³ã‚¯ (å†ã‚ªãƒ¼ãƒ—ãƒ³)
                STATUS="ğŸ”„ Issue Reopened"
                ;;
              "edited")
                COLOR=8421504  # âš« ã‚°ãƒ¬ãƒ¼ (ç·¨é›†)
                STATUS="âœï¸ Issue Edited"
                ;;
              "assigned")
                ASSIGNEE="${{ github.event.assignee.login }}"
                COLOR=16776960  # ğŸŸ¡ é»„è‰² (æ‹…å½“è€…ã‚¢ã‚µã‚¤ãƒ³)
                STATUS="ğŸ‘¤ Assigned to $ASSIGNEE"
                ;;
              *)
                echo "No notification needed for action: $ACTION_TYPE"
                exit 0  # ğŸš€ ä¸è¦ãªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã®å ´åˆã¯é€šçŸ¥ã—ãªã„
                ;;
            esac
          fi

          # JSONãƒ‡ãƒ¼ã‚¿ã‚’ payload.json ã«ä¿å­˜ (å®‰å…¨ãªæ–¹æ³•)
          printf '{
            "username": "GitHub Issue Bot",
            "avatar_url": "https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png",
            "embeds": [{
                "title": "%s",
                "url": "%s",
                "description": %s,
                "color": %d,
                "fields": [
                  {
                    "name": "ğŸ”¹ Repository",
                    "value": "%s",
                    "inline": true
                  },
                  {
                    "name": "ğŸ‘¤ Created by",
                    "value": "%s",
                    "inline": true
                  },
                  {
                    "name": "ğŸ“Œ Status",
                    "value": "%s",
                    "inline": false
                  }
                ],
                "footer": {
                    "text": "GitHub Issue Update | %s"
                },
                "timestamp": "%s"
            }]
          }' \
          "$ISSUE_TITLE" "$ISSUE_URL" "$ESCAPED_BODY" "$COLOR" \
          "$REPO_NAME" "$ISSUE_AUTHOR" "$STATUS" "$ACTION_TYPE" \
          "$(date -u +"%Y-%m-%dT%H:%M:%SZ")" > payload.json

          # ç¢ºå®Ÿã« JSON ã‚’ãƒ­ã‚°ã«è¡¨ç¤º
          echo "==== Generated payload.json ===="
          cat payload.json
          echo "================================"

          # Discord ã«é€ä¿¡
          curl -H "Content-Type: application/json" \
               -X POST \
               -d @payload.json \
               $DISCORD_WEBHOOK
