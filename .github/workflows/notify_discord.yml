name: Notify Discord on Issue Updates and Comments

on:
  issues:
    types: [opened, closed, reopened, edited, assigned]
  issue_comment:
    types: [created]

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: Send Discord Notification
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
          ISSUE_TITLE: ${{ github.event.issue.title }}
          ISSUE_URL: ${{ github.event.issue.html_url }}
          ISSUE_BODY: ${{ github.event.issue.body }}
          ISSUE_AUTHOR: ${{ github.event.issue.user.login }}
          ACTION_TYPE: ${{ github.event.action }}
          REPO_NAME: ${{ github.repository }}
          COMMENT_BODY: ${{ github.event.comment.body }}
          COMMENT_AUTHOR: ${{ github.event.comment.user.login }}
          GITHUB_EVENT_NAME: ${{ github.event_name }}
        run: |
          # Determine event type
          if [ "$GITHUB_EVENT_NAME" == "issue_comment" ]; then
            ESCAPED_BODY=$(echo "$COMMENT_BODY" | jq -Rs .)  # JSON escape
            COLOR=16777215  # âšª White (comment)
            STATUS="ðŸ’¬ New Comment by $COMMENT_AUTHOR"
          else
            ESCAPED_BODY=$(echo "$ISSUE_BODY" | jq -Rs .)  # JSON escape Issue body
            COMMENT_AUTHOR=""

            case "$ACTION_TYPE" in
              "opened")
                COLOR=16711680  # ðŸ”´ Red (new Issue)
                STATUS="ðŸ†• New Issue Created"
                ;;
              "closed")
                COLOR=65280  # ðŸŸ¢ Green (close)
                STATUS="âœ… Issue Closed"
                ;;
              "reopened")
                COLOR=16711935  # ðŸ’– Pink (reopen)
                STATUS="ðŸ”„ Issue Reopened"
                ;;
              "edited")
                COLOR=8421504  # âš« Gray (edit)
                STATUS="âœï¸ Issue Edited"
                ;;
              "assigned")
                ASSIGNEE="${{ github.event.assignee.login }}"
                COLOR=16776960  # ðŸŸ¡ Yellow (assignee assign)
                STATUS="ðŸ‘¤ Assigned to $ASSIGNEE"
                ;;
              *)
                echo "No notification needed for action: $ACTION_TYPE"
                exit 0  # ðŸš€ Don't notify for unnecessary actions
                ;;
            esac
          fi

          # Save JSON data to payload.json (safe method)
          printf '{
            "username": "GitHub Issue Bot",
            "avatar_url": "https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png",
            "embeds": [{
                "title": "%s",
                "url": "%s",
                "description": %s,
                "color": %d,
                "fields": [
                  {
                    "name": "ðŸ”¹ Repository",
                    "value": "%s",
                    "inline": true
                  },
                  {
                    "name": "ðŸ‘¤ Created by",
                    "value": "%s",
                    "inline": true
                  },
                  {
                    "name": "ðŸ“Œ Status",
                    "value": "%s",
                    "inline": false
                  }
                ],
                "footer": {
                    "text": "GitHub Issue Update | %s"
                },
                "timestamp": "%s"
            }]
          }' \
          "$ISSUE_TITLE" "$ISSUE_URL" "$ESCAPED_BODY" "$COLOR" \
          "$REPO_NAME" "$ISSUE_AUTHOR" "$STATUS" "$ACTION_TYPE" \
          "$(date -u +"%Y-%m-%dT%H:%M:%SZ")" > payload.json

          # Display JSON in log for verification
          echo "==== Generated payload.json ===="
          cat payload.json
          echo "================================"

          # Send to Discord
          curl -H "Content-Type: application/json" \
               -X POST \
               -d @payload.json \
               $DISCORD_WEBHOOK
